// Prisma Schema for MeetAndGo Tourism Application
// Database: PostgreSQL
// ORM: Prisma 6

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================

enum UserRole {
  CUSTOMER
  ADMIN
  TOUR_GUIDE
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String?   @unique
  phone         String?   @unique
  emailVerified DateTime?
  phoneVerified DateTime?
  password      String
  image         String?
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts       Account[]
  sessions       Session[]
  bookings       Booking[]
  customRequests CustomTourRequest[]
  participants   Participant[]
  assignedTours  CustomTourRequest[] @relation("TourGuideAssignment")

  @@index([email])
  @@index([phone])
  @@index([role])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =============================================================================
// TOUR PACKAGES
// =============================================================================

enum TripType {
  OPEN_TRIP
  PRIVATE_TRIP
}

model TourPackage {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  tripType    TripType
  location    String
  description String   @db.Text
  duration    String   // e.g., "3 Days 2 Nights"
  durationDays Int     @default(1)
  thumbnail   String?  // Main image URL
  images      String[] // Additional images
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  highlights    Highlight[]
  itineraries   Itinerary[]
  includedItems IncludedItem[]
  excludedItems ExcludedItem[]
  meetingPoints MeetingPoint[]
  departures    Departure[]

  @@index([slug])
  @@index([tripType])
  @@index([isActive])
  @@index([location])
}

model Highlight {
  id            String      @id @default(cuid())
  tourPackageId String
  title         String
  description   String?
  image         String?
  order         Int         @default(0)
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)

  @@index([tourPackageId])
}

model Itinerary {
  id            String           @id @default(cuid())
  tourPackageId String
  day           Int              // Day number
  title         String?          // e.g., "Arrival Day"
  order         Int              @default(0)
  tourPackage   TourPackage      @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)
  activities    ItineraryActivity[]

  @@index([tourPackageId])
  @@unique([tourPackageId, day])
}

model ItineraryActivity {
  id          String    @id @default(cuid())
  itineraryId String
  startTime   String    // e.g., "07:45"
  endTime     String    // e.g., "08:45"
  activity    String
  description String?
  order       Int       @default(0)
  itinerary   Itinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  @@index([itineraryId])
}

model IncludedItem {
  id            String      @id @default(cuid())
  tourPackageId String
  item          String
  order         Int         @default(0)
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)

  @@index([tourPackageId])
}

model ExcludedItem {
  id            String      @id @default(cuid())
  tourPackageId String
  item          String
  order         Int         @default(0)
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)

  @@index([tourPackageId])
}

model MeetingPoint {
  id            String      @id @default(cuid())
  tourPackageId String
  name          String
  address       String?
  time          String?     // e.g., "06:00"
  order         Int         @default(0)
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)

  @@index([tourPackageId])
}

// =============================================================================
// DEPARTURES & GROUPS (Scheduling)
// =============================================================================

model Departure {
  id            String      @id @default(cuid())
  tourPackageId String
  departureDate DateTime    @db.Date
  
  // For OPEN_TRIP: price per person
  pricePerPerson Decimal?   @db.Decimal(12, 2)
  maxParticipants Int?
  
  // For PRIVATE_TRIP: uses groups
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)
  groups        DepartureGroup[]
  bookings      Booking[]

  @@unique([tourPackageId, departureDate])
  @@index([tourPackageId])
  @@index([departureDate])
  @@index([isActive])
}

model DepartureGroup {
  id              String    @id @default(cuid())
  departureId     String
  groupNumber     Int       // Group 1, Group 2, etc.
  price           Decimal   @db.Decimal(12, 2)
  maxParticipants Int       // Max participants in this group
  isBooked        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  departure       Departure @relation(fields: [departureId], references: [id], onDelete: Cascade)
  booking         Booking?  // One-to-one: one group can only have one booking

  @@unique([departureId, groupNumber])
  @@index([departureId])
  @@index([isBooked])
}

// =============================================================================
// BOOKINGS
// =============================================================================

enum BookingStatus {
  PENDING           // Just created, waiting for payment
  PAYMENT_RECEIVED  // Payment confirmed
  PROCESSED         // Admin processed the booking
  ONGOING           // Trip is ongoing
  COMPLETED         // Trip completed
  CANCELLED         // Cancelled (timeout or manual)
  EXPIRED           // Payment timeout (24h)
}

model Booking {
  id              String        @id @default(cuid())
  bookingCode     String        @unique
  userId          String
  departureId     String
  departureGroupId String?      @unique // For private trips (one booking per group)
  tripType        TripType
  totalAmount     Decimal       @db.Decimal(12, 2)
  participantCount Int          @default(1)
  status          BookingStatus @default(PENDING)
  paymentDeadline DateTime      // 24 hours from creation
  paidAt          DateTime?
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Payment fields - ADD THESE
  paymentMethod     String?       // "MIDTRANS" or "MANUAL_TRANSFER"
  paymentToken      String?
  paymentUrl        String?
  paymentProof      String?       // URL to uploaded payment proof image

  // Relations
  user            User          @relation(fields: [userId], references: [id])
  departure       Departure     @relation(fields: [departureId], references: [id])
  departureGroup  DepartureGroup? @relation(fields: [departureGroupId], references: [id])
  participants    BookingParticipant[]

  @@index([userId])
  @@index([departureId])
  @@index([status])
  @@index([bookingCode])
  @@index([paymentDeadline])
}

// =============================================================================
// PARTICIPANTS
// =============================================================================

enum Gender {
  MALE
  FEMALE
}

model Participant {
  id            String   @id @default(cuid())
  userId        String   // Owner of this participant data
  fullName      String
  idNumber      String?  // KTP number
  gender        Gender
  birthPlace    String?
  birthDate     DateTime? @db.Date
  phone         String?
  domicile      String?
  email         String?
  address       String?  @db.Text
  healthHistory String?  @db.Text
  ktpImage      String?  // KTP image URL
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings      BookingParticipant[]

  @@unique([userId, idNumber])  // Prevents duplicate ID per user
  @@index([userId])
  @@index([fullName])
}

model BookingParticipant {
  id            String      @id @default(cuid())
  bookingId     String
  participantId String
  isPrimary     Boolean     @default(false) // Primary contact
  
  booking       Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  participant   Participant @relation(fields: [participantId], references: [id])

  @@unique([bookingId, participantId])
  @@index([bookingId])
  @@index([participantId])
}

// =============================================================================
// CUSTOM TOUR REQUESTS
// =============================================================================

enum CustomRequestStatus {
  PENDING     // Just submitted
  IN_REVIEW   // Admin reviewing, can set estimated price
  ACCEPTED    // Admin accepted, final price set
  PAID        // Customer paid
  PROCESSED   // Admin processed
  ONGOING     // Tour ongoing
  COMPLETED   // Tour completed
  REJECTED    // Admin rejected
  CANCELLED   // Customer cancelled
}

model CustomTourRequest {
  id              String              @id @default(cuid())
  requestCode     String              @unique
  userId          String
  
  destination     String
  duration        String              // e.g., "5 Days 4 Nights"
  departureDate   DateTime            @db.Date
  meetingPoint    String
  participantCount Int
  notes           String?             @db.Text
  
  estimatedPrice  Decimal?            @db.Decimal(12, 2) // Admin can set/unset multiple times
  finalPrice      Decimal?            @db.Decimal(12, 2) // Set when accepted
  
  status          CustomRequestStatus @default(PENDING)
  tourGuideId     String?             // Assigned when status is ONGOING
  
  adminNotes      String?             @db.Text
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  user            User                @relation(fields: [userId], references: [id])
  tourGuide       User?               @relation("TourGuideAssignment", fields: [tourGuideId], references: [id])
  priceHistory    PriceEstimateHistory[]

  @@index([userId])
  @@index([status])
  @@index([requestCode])
  @@index([tourGuideId])
}

model PriceEstimateHistory {
  id              String            @id @default(cuid())
  requestId       String
  estimatedPrice  Decimal           @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime          @default(now())
  
  request         CustomTourRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}
